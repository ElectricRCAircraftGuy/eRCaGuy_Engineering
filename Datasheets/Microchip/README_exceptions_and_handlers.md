

# See also

1. TODO: add links to my other related readmes here.


# References

1. https://en.wikipedia.org/wiki/MIPS_architecture - mips16 vs mips32 instruction set, etc.
    > **MIPS16**
    > 
    > MIPS16 is an Application-Specific Extension for MIPS I through to V designed by LSI Logic and MIPS Technologies, announced on October 21, 1996, alongside its first implementation, the LSI Logic TinyRISC processor.[33] MIPS16 was subsequently licensed by NEC Electronics, Philips Semiconductors, and Toshiba (among others); and implemented as an extension to the MIPS I, II, an III architectures. MIPS16 decreases the size of application by up to 40% by using 16-bit instructions instead of 32-bit instructions and also improves power efficiency, the instruction cache hit rate, and is equivalent in performance to its base architecture.[34] It is supported by hardware and software development tools from MIPS Technologies and other providers. MIPS16e is an improved version of MIPS16 first supported by MIPS32 and MIPS64 Release 1. MIPS16e2 is an improved version of MIPS16 that is supported by MIPS32 and MIPS64 (up to Release 5). Release 6 replaced it with microMIPS.

1. https://gcc.gnu.org/onlinedocs/gcc/MIPS-Function-Attributes.html - MIPS function attributes; ex: `nomips16`:
    ```c
    void __attribute__((nomips16)) _general_exception_handler(void);
    ```
1. https://developerhelp.microchip.com/xwiki/bin/view/products/mcu-mpu/32bit-mcu/PIC32/mx-arch-cpu-overview/exception-mechanism/usage/ - says that you *must* use the `nomips16` attribute!: 
    ```c
    void __attribute__((nomips16)) _general_exception_handler(void);
    ```


# PIC32 Exceptions and Handlers

To see what an example `_general_exception_handler()` function might look like, in particular on a smaller MCU than the `PIC32MZ2048EFM144`, and possibly auto-generated by either Harmony or the MPLAB(c) Code Configurator (MPLAB CC), run this: 

```bash
cd "path/to/eRCaGuy_Engineering/Datasheets/Microchip"

# Run ripgrep all: eRCaGuy_Engineering/Datasheets/Microchip
rga -F '_CP0_GET_CAUSE'
# OR: just list files
rga -l -F '_CP0_GET_CAUSE'
```

Take a look at these files from the output of the command above:
1. [XC32_Compiler/XC32_UG_EE_Examples/Example5.X/mcc_generated_files/mcc.c](XC32_Compiler/XC32_UG_EE_Examples/Example5.X/mcc_generated_files/mcc.c)
1. [XC32_Compiler/XC32_UG_EE_Examples/Example3.X/example3.c](XC32_Compiler/XC32_UG_EE_Examples/Example3.X/example3.c)
1. [XC32_Compiler/XC32_UG_EE_Examples/Example7.X/mcc_generated_files/mcc.c](XC32_Compiler/XC32_UG_EE_Examples/Example7.X/mcc_generated_files/mcc.c)
1. [XC32_Compiler/XC32_UG_EE_Examples/Example4/firmware/src/system_config/explorer1632/system_exceptions.c](XC32_Compiler/XC32_UG_EE_Examples/Example4/firmware/src/system_config/explorer1632/system_exceptions.c)
1. [XC32_Compiler/XC32_UG_EE_Examples/Example6/firmware/src/system_config/explorer1632/system_exceptions.c](XC32_Compiler/XC32_UG_EE_Examples/Example6/firmware/src/system_config/explorer1632/system_exceptions.c)
1. [XC32_Compiler/50002509B [XC32 User's Guide for Embedded Engineers] [code examples].pdf](<XC32_Compiler/50002509B [XC32 User's Guide for Embedded Engineers] [code examples].pdf>)

Ex: from [XC32_Compiler/XC32_UG_EE_Examples/Example5.X/mcc_generated_files/mcc.c](XC32_Compiler/XC32_UG_EE_Examples/Example5.X/mcc_generated_files/mcc.c) we have:

```c
/**
  @Generated MPLAB(c) Code Configurator Source File

  @Company:
    Microchip Technology Inc.

  @File Name:
    mcc.c

  @Summary:
    This is the mcc.c file generated using MPLAB(c) Code Configurator

...
**/

// Configuration bits: selected in the GUI

// DEVCFG3
#pragma config FSRSSEL = PRIORITY_7    // Shadow Register Set Priority Select->SRS Priority 7
#pragma config PMDL1WAY = ON    // Peripheral Module Disable Configuration->Allow only one reconfiguration
#pragma config IOL1WAY = ON    // Peripheral Pin Select Configuration->Allow only one reconfiguration
#pragma config FUSBIDIO = ON    // USB USID Selection->Controlled by the USB Module
#pragma config FVBUSONIO = ON    // USB VBUS ON Selection->Controlled by USB Module

// DEVCFG2
#pragma config FPLLIDIV = DIV_12    // PLL Input Divider->12x Divider
#pragma config FPLLMUL = MUL_24    // PLL Multiplier->24x Multiplier
#pragma config UPLLIDIV = DIV_12    // USB PLL Input Divider->12x Divider
#pragma config UPLLEN = OFF    // USB PLL Enable->Disabled and Bypassed
#pragma config FPLLODIV = DIV_256    // System PLL Output Clock Divider->PLL Divide by 256

// DEVCFG1
#pragma config FNOSC = FRCDIV    // Oscillator Selection Bits->Fast RC Osc w/Div-by-N (FRCDIV)
#pragma config FSOSCEN = ON    // Secondary Oscillator Enable->Enabled
#pragma config IESO = ON    // Internal/External Switch Over->Enabled
#pragma config POSCMOD = OFF    // Primary Oscillator Configuration->Primary osc disabled
#pragma config OSCIOFNC = ON    // CLKO Output Signal Active on the OSCO Pin->Enabled
#pragma config FPBDIV = DIV_2    // Peripheral Clock Divisor->Pb_Clk is Sys_Clk/2
#pragma config FCKSM = CSDCMD    // Clock Switching and Monitor Selection->Clock Switch Disable, FSCM Disabled
#pragma config WDTPS = PS1048576    // Watchdog Timer Postscaler->1:1048576
#pragma config WINDIS = OFF    // Watchdog Timer Window Enable->Watchdog Timer is in Non-Window Mode
#pragma config FWDTEN = OFF    // Watchdog Timer Enable->WDT Disabled (SWDTEN Bit Controls)
#pragma config FWDTWINSZ = WINSZ_25    // Watchdog Timer Window Size->Window Size is 25%

// DEVCFG0
#pragma config DEBUG = OFF    // Background Debugger Enable->Debugger is Disabled
#pragma config JTAGEN = OFF    // JTAG Enable->JTAG Disabled
#pragma config ICESEL = ICS_PGx2    // ICE/ICD Comm Channel Select->Communicate on PGEC2/PGED2
#pragma config PWP = OFF    // Program Flash Write Protect->Disable
#pragma config BWP = OFF    // Boot Flash Write Protect bit->Protection Disabled
#pragma config CP = OFF    // Code Protect->Protection Disabled

#include "mcc.h"

/**
  @Summary
    Indicates the exception cause. 

  @Description
    This array identifies the cause for exception.
 */

static char *cause[] = 
{
    "Interrupt", "Undefined", "Undefined", "Undefined",
    "Load/fetch address error", "Store address error",
    "Instruction bus error", "Data bus error", "Syscall", 
    "Breakpoint", "Reserved instruction", "Coprocessor unusable", 
    "Arithmetic overflow", "Trap", "Reserved", "Reserved", 
    "Reserved", "Reserved", "Reserved"
};

// ...

void _general_exception_handler ()
{
    /* Mask off the ExcCode Field from the Cause Register
    Refer to the MIPs Software User's manual */
    uint8_t _excep_code;
    uint8_t _excep_addr;
    uint8_t *_cause_str;
    _excep_code = (_CP0_GET_CAUSE() & 0x0000007C) >> 2;
    _excep_addr = _CP0_GET_EPC();
    _cause_str  = cause[_excep_code];

    while(1)
    {
      ;
    }
}
```

Note that this particular chip only has 19 exception causes (indices 0-18), apparently, so the `cause[]` array only has 19 elements. 

A bigger chip, such as `PIC32MZ2048EFM144`, will have 32 exception causes (indices 0-31), so long as all 3 notes here at the bottom of pg 69 apply: [PIC32M_Family_Reference_Manual/Section 50. CPU for Devices with MIPS32® microAptiv™ and M-Class Cores-60001192B (qpdf --decrypt)_GS_edit.pdf](<PIC32M_Family_Reference_Manual/Section 50. CPU for Devices with MIPS32® microAptiv™ and M-Class Cores-60001192B (qpdf --decrypt)_GS_edit.pdf>):

<p align="left" width="100%">
    <a href="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/e62e34e1-1cf5-423f-9cfd-4841f93d991f">
        <img width="90%" src="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/e62e34e1-1cf5-423f-9cfd-4841f93d991f"> 
    </a>
</p>

Those 5 bits are bits 4:0 of the "Cause Register", `EXCCODE`. ie: `EXCCODE[4:0]`. The `EXCCODE` field is bits `6:2` of the `Exception Cause Register; CP0 Register 13, Select 0`, as shown on p70 of the same PDF above,here:

<p align="left" width="100%">
    <a href="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/a8147c67-6b20-441e-b32e-89c26b380481">
        <img width="90%" src="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/a8147c67-6b20-441e-b32e-89c26b380481"> 
    </a>
</p>

So, to read those 5 bits for the `EXCCODE` field, we do this:

```c
_excep_code = (_CP0_GET_CAUSE() & 0x0000007C) >> 2;  // Note that 0x7C = 0b01111100
```

**So, an updated version of the `_general_exception_handler()` function for a `PIC32MZ2048EFM144` might look like this: [PIC32MZ2048EFM144/exception_handlers.c](PIC32MZ2048EFM144/exception_handlers.c)**

For a longer description of the exceptions, in particular as they apply to a specific mcu, see the datasheet for a given mcu.  
Ex: [PIC32MZ2048EFM144/PIC32MZ-Embedded-Connectivity-with-Floating-Point-Unit-Family-Data-Sheet-DS60001320H_GS_edit (qpdf --decrypt).pdf](<PIC32MZ2048EFM144/PIC32MZ-Embedded-Connectivity-with-Floating-Point-Unit-Family-Data-Sheet-DS60001320H_GS_edit (qpdf --decrypt).pdf>):

p128:  
Notice the "Description" column:
<p align="left" width="100%">
    <a href="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/1b74cbb1-0e6d-4049-bc4c-8c5a6bac8eb8">
        <img width="90%" src="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/1b74cbb1-0e6d-4049-bc4c-8c5a6bac8eb8"> 
    </a>
</p>

p129:  
<p align="left" width="100%">
    <a href="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/da02fc27-9637-4fab-91a6-615045923eac">
        <img width="90%" src="https://github.com/ElectricRCAircraftGuy/eRCaGuy_Engineering/assets/6842199/da02fc27-9637-4fab-91a6-615045923eac"> 
    </a>
</p>
